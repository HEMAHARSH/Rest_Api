---
- name: Check if service is running
  win_shell: "(Get-Service -Name '{{ service_name }}').Status"
  register: service_status

- name: Create one record per host
  set_fact:
    service_record:
      host: "{{ inventory_hostname }}"
      service_name: "{{ service_name }}"
      status: "{{ service_status.stdout }}"

# Append record to a temporary JSON-lines file in Jenkins workspace
- name: Append service result (each host adds one line)
  lineinfile:
    path: "service_status_temp.jsonl"
    line: "{{ service_record | to_json }}"
    create: yes
  delegate_to: localhost

# After all hosts finish â†’ convert JSONL to valid JSON array
- name: Build final JSON file
  shell: |
    echo "[" > service_status_output.json
    sed -e '$!s/$/,/' service_status_temp.jsonl >> service_status_output.json
    echo "]" >> service_status_output.json
  args:
    executable: /bin/bash
  delegate_to: localhost
  run_once: true

# Read the JSON into Ansible
- name: Read final JSON
  slurp:
    src: "service_status_output.json"
  register: json_data
  delegate_to: localhost
  run_once: true

# Build HTML report in workspace
- name: Generate HTML report
  template:
    src: "template.html.j2"
    dest: "service_status_report.html"
  vars:
    service_statuses: "{{ json_data.content | b64decode | from_json }}"
  delegate_to: localhost
  run_once: true
